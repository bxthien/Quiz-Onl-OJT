<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generator</title>
    <script>
        async function generateQuiz(event) {
            event.preventDefault();

            const topic = document.getElementById("topic").value;
            const difficulty = document.getElementById("difficulty").value;
            const language = document.getElementById("language").value;
            const amount = document.getElementById("amount").value;
            const outputElement = document.getElementById("output");
            const loadingElement = document.getElementById("loading");


            outputElement.textContent = "";
            loadingElement.style.display = "block";

            const quizPromptFormat = `
Create a multiple-choice quiz on the topic of ${topic}. 
The quiz should have ${amount} questions, each with four answer choices (A, B, C, and D). 
Some questions may have **more than one correct answer** (e.g., "A and C" or "B, C, and D"). 

For each question:
- Provide four answer choices (A, B, C, and D).
- Indicate all correct answers (can be one or multiple choices).
- Provide a short explanation for why each correct answer is correct.

Ensure the questions are at a difficulty level of ${difficulty}. 
Format the output as a **valid JSON array** with the following structure:
[
  {
    "question": "Question text",
    "answers": { "A": "Option 1", "B": "Option 2", "C": "Option 3", "D": "Option 4" },
    "correct_answers": ["A", "C"],  
    "short_explain_for_answer": {
      "A": "Explanation for A",
      "C": "Explanation for C"
    }
  }
]

Generate the quiz in ${language}. 
Ensure the response is a **valid JSON array** without additional explanations, comments, or text.
`;

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyAchUc_ifLB0eDwpAIP9eDmzFA_KRxXnSg`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: quizPromptFormat }] }] })
                    }
                );

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.statusText}`);
                }

                const data = await response.json();
                let responseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!responseText) {
                    throw new Error("No valid response from Gemini AI.");
                }

                responseText = responseText.replace(/```json|```/g, "").trim();
                responseText = responseText.replace(/,\s*}/g, "}").replace(/,\s*]/g, "]");

                const quizData = JSON.parse(responseText);

                // Save quiz data to local storage
                localStorage.setItem("QuizData", JSON.stringify(quizData));

                outputElement.textContent = JSON.stringify(quizData, null, 2);
            } catch (error) {
                console.error("Error generating quiz:", error);
                outputElement.textContent = "❌ Error generating quiz. See console for details.";
            } finally {
                loadingElement.style.display = "none";
            }
        }
    </script>
</head>

<body>
    <h2>Generate a Quiz</h2>
    <form onsubmit="generateQuiz(event)">
        <label for="topic">Topic:</label>
        <input type="text" id="topic" name="topic" required><br><br>

        <label for="difficulty">Difficulty:</label>
        <select id="difficulty" name="difficulty">
            <option value="Easy">Easy</option>
            <option value="Medium" selected>Medium</option>
            <option value="Hard">Hard</option>
        </select><br><br>

        <label for="language">Language:</label>
        <input type="text" id="language" name="language" value="Vietnamese" required><br><br>

        <label for="amount">Number of Questions:</label>
        <input type="number" id="amount" name="amount" value="20" required><br><br>

        <button type="submit">Generate Quiz</button>
    </form>

    <h3>Quiz Output:</h3>
    <div id="loading" style="display: none;">⏳ Generating quiz, please wait...</div>
    <pre id="output"></pre>
</body>

</html>